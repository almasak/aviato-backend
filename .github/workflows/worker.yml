name: Process Task Worker

on:
  repository_dispatch:
    types: [process-task]

jobs:
  process:
    runs-on: ubuntu-latest

    env:
      WORKER_URL: ${{ secrets.WORKER_URL }}
      INTERNAL_SECRET: ${{ secrets.INTERNAL_SECRET }}

    steps:

      - name: Dump env names (safe)
        run: |
          env | sort | grep WORKER || true

      - name: Debug WORKER_URL
        run: |
          if [ -z "$WORKER_URL" ]; then
            echo "❌ WORKER_URL is empty or not set"
            exit 1
          fi
          echo "✅ WORKER_URL=$WORKER_URL"

      - name: Log task start
        run: |
          echo "Task ID: ${{ github.event.client_payload.taskId }}"

      - name: Mark task as running
        run: |
          curl -s -X POST "$WORKER_URL/internal/task/start" \
            -H "Content-Type: application/json" \
            -H "x-internal-secret: $INTERNAL_SECRET" \
            -d '{
              "taskId": "${{ github.event.client_payload.taskId }}"
            }'

      - name: Do dummy work
        run: |
          echo "Doing dummy work..."
          sleep 5

      - name: Mark task as completed
        run: |
          curl -s -X POST "$WORKER_URL/internal/task/complete" \
            -H "Content-Type: application/json" \
            -H "x-internal-secret: $INTERNAL_SECRET" \
            -d '{
              "taskId": "${{ github.event.client_payload.taskId }}",
              "result": {
                "status": "ok",
                "message": "Dummy work completed"
              }
            }'
